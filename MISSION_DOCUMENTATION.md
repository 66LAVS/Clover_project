# Clover Mission Control — документация

## 1. Назначение

Веб-приложение предназначено для миссионного управления дроном Clover:
- построение маршрута на карте OSM;
- импорт маршрута из Alpine Quest (GPX);
- запуск автоматической миссии;
- мониторинг ошибок и стабильности;
- отдельный экран батареи и данных дрона.

Карта реализована на **OpenLayers** (Leaflet удалён).

---

## 2. Структура интерфейса

Приложение состоит из 4 вкладок:

1. **Миссия**
   - подключение к ROS Bridge (WebSocket);
   - параметры полёта;
   - кнопки управления миссией;
   - журнал событий;
   - краткая телеметрия.

2. **Карта**
   - OpenLayers + OSM;
   - добавление маршрута кликами;
   - динамическое число WP (`WP1..WPN`) + END;
   - импорт GPX;
   - удаление последней точки, очистка маршрута;
   - визуализация обратного пути.

3. **Ошибки**
   - таблица диагностик со статусами `OK / CHECK / ERROR`;
   - для каждой проверки выводятся детали и рекомендуемое решение.

4. **Батарея и дрон**
   - состояние батареи (процент, напряжение, ток);
   - состояние FCU (mode, armed, connected);
   - GPS данные;
   - попытка получения данных о платформе и serial/uid.

---

## 3. Логика маршрута и миссии

### 3.1 Построение маршрута

- Пользователь задаёт лимит промежуточных точек `N` в поле «Количество промежуточных точек WP».
- По клику на карте заполняются:
  - сначала `WP1..WPN`;
  - затем `END`.

### 3.2 Импорт GPX

- Считываются `trkpt` (или `wpt`, если `trkpt` нет).
- Берутся первые `N` точек как WP и следующая как END.

### 3.3 Сценарий миссии

1. Проход по `WP1..WPN` на крейсерской высоте/скорости.
2. Переход в `END` со снижением (alt/speed снижения).
3. Действие в END:
   - `manual_stop`: передача в ручное управление и завершение;
   - `drop_continue`: ожидание подтверждения оператора.
4. Возврат по обратному пути `WPN..WP1`.
5. После возврата: `hover` или `land`.

---

## 4. Мониторинг ошибок

Вкладка «Ошибки» контролирует:

- WebSocket / ROS Bridge;
- поток GPS;
- GPS fix;
- батарею;
- готовность маршрута;
- состояние миссии;
- доступность ROS-сервисов.

При проблеме показываются:
- статус `ERROR`;
- краткая деталь;
- возможное решение (что проверить оператору).

Если узел работает стабильно — отображается `OK`.

---

## 5. ROS topics/services, используемые в приложении

### Подписки (topics)

- `/mavros/global_position/global`
- `/mavros/global_position/raw/fix`
- `/mavros/state`
- `/mavros/battery`
- `/mavros/statustext/recv`

### Сервисы (call_service)

- `/navigate_global`
- `/land`
- `/release`
- `/mavros/set_mode`
- `/mavros/vehicle_info_get`

---

## 6. Серийный номер и данные дрона

Кнопка «Запросить данные FCU/серийный номер» вызывает `/mavros/vehicle_info_get`.

Важно:
- не все автопилоты/прошивки отдают serial/uid через MAVROS;
- в этом случае отображается `Недоступно`;
- могут быть доступны только `sysid/compid`, тип автопилота и тип ТС.

---

## 7. Безопасность

- При потере GPS во время миссии (fix потерян или нет обновления > 5 сек) миссия останавливается.
- Выполняется переход на ручной режим (`/release` + `set_mode POSITION`).
- Оператор получает уведомление.

---

## 8. Запуск

1. Открыть `index.html` в браузере.
2. Перейти во вкладку «Миссия» и подключиться к ROS Bridge.
3. Во вкладке «Карта» задать маршрут (или импортировать GPX).
4. Проверить вкладки «Ошибки» и «Батарея и дрон».
5. Запустить миссию.
